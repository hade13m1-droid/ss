<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Admin | Hade Control Panel</title>
  <style>
    :root{--bg:#0b0f1f;--panel:rgba(0,0,0,.62);--line:rgba(255,255,255,.14);--txt:#fff;--muted:rgba(255,255,255,.72);--ok:#8ff7ca;--bad:#ff8ea8}
    *{box-sizing:border-box}body{margin:0;font-family:Inter,system-ui;background:radial-gradient(circle at 10% 10%,#20295a,#0b0f1f 65%);color:var(--txt)}
    .shell{max-width:1150px;margin:16px auto;padding:12px}.card{background:var(--panel);border:1px solid var(--line);border-radius:16px;padding:12px;backdrop-filter:blur(10px)}
    .top{display:flex;justify-content:space-between;gap:.5rem;align-items:center;flex-wrap:wrap}.actions{display:flex;flex-wrap:wrap;gap:.5rem}
    .btn{border:1px solid var(--line);background:rgba(255,255,255,.04);color:#fff;border-radius:999px;padding:.45rem .8rem;cursor:pointer;text-decoration:none}
    .layout{display:grid;grid-template-columns:1.25fr .75fr;gap:1rem;margin-top:1rem}.grid{display:grid;grid-template-columns:1fr 1fr;gap:.55rem}
    label{display:grid;gap:.3rem;color:var(--muted);font-size:.9rem}input,textarea{border:1px solid var(--line);background:rgba(255,255,255,.03);color:#fff;border-radius:10px;padding:.55rem .62rem;font:inherit}
    .full{grid-column:1/-1}.upload{display:flex;gap:.45rem;align-items:center;flex-wrap:wrap}.preview{width:84px;height:84px;border-radius:12px;object-fit:cover;border:1px solid var(--line)}
    .status{min-height:1.2em;color:var(--ok)}.msg{border:1px solid var(--line);border-radius:10px;padding:.5rem;background:rgba(255,255,255,.03)}.meta{font-size:.8rem;color:var(--muted);display:flex;justify-content:space-between}
    .msgs{display:grid;gap:.45rem;max-height:70vh;overflow:auto}.small{font-size:.82rem;color:var(--muted)}
    @media (max-width:980px){.layout{grid-template-columns:1fr}.grid{grid-template-columns:1fr}}
  </style>
</head>
<body>
  <main class="shell">
    <section class="card">
      <div class="top">
        <h1 style="margin:0">⚙ Hade Admin Panel</h1>
        <div class="actions">
          <button id="reload" class="btn" type="button">Reload</button>
          <button id="refresh" class="btn" type="button">Refresh Inbox</button>
          <a class="btn" href="/">Open Profile</a>
        </div>
      </div>
      <p class="status" id="status"></p>
    </section>

    <section class="layout">
      <form id="f" class="card grid">
        <label>Name <input id="name"></label>
        <label>Description <input id="description"></label>
        <label>Place <input id="place"></label>
        <label>Views <input id="views" type="number" min="0"></label>
        <label>Availability <input id="availability"></label>
        <label>Accent Color <input id="accentColor" placeholder="#ffffff"></label>
        <label>Card Opacity (0-1) <input id="cardOpacity" type="number" min="0" max="1" step="0.05"></label>
        <label>Music Title <input id="musicTitle"></label>
        <label>Music URL <input id="music"></label>
        <label>Video URL <input id="video"></label>
        <label>PFP URL <input id="pfp"></label>
        <label>Avatar Decoration URL <input id="avatarDecoration"></label>
        <label>Music Cover URL <input id="musicCover"></label>
        <label>Weather City <input id="weatherCity"></label>
        <label>Weather Temp <input id="weatherTemp"></label>
        <label class="full">Weather Condition <input id="weatherCondition"></label>

        <label class="full">About lines (one per line)<textarea id="aboutLines" rows="5"></textarea></label>
        <label class="full">Links JSON<textarea id="links" rows="6"></textarea></label>
        <label class="full">Projects JSON<textarea id="projects" rows="7"></textarea></label>

        <div class="full upload">
          <img id="p" class="preview" src="/uploads/default-pfp.svg" alt="pfp preview">
          <input id="pfpFile" type="file" accept="image/*">
          <button id="upPfp" type="button" class="btn">Upload PFP</button>
          <input id="genericFile" type="file" accept="image/*,video/mp4,audio/mpeg,audio/mp3">
          <button id="upAny" type="button" class="btn">Upload Media</button>
          <input id="uploadedUrl" placeholder="uploaded URL" style="min-width:260px">
        </div>

        <div class="full actions"><button class="btn" type="submit">Save Config</button></div>
      </form>

      <aside class="card">
        <h2 style="margin:.1rem 0 .4rem">Inbox</h2>
        <input id="q" placeholder="search messages..." class="full" style="width:100%">
        <p class="small" id="count"></p>
        <div id="msgs" class="msgs"></div>
      </aside>
    </section>
  </main>

  <script>
    const $=id=>document.getElementById(id); let all=[];
    const ids=['name','description','place','views','availability','accentColor','cardOpacity','musicTitle','music','video','pfp','avatarDecoration','musicCover','weatherCity','weatherTemp','weatherCondition'];
    function status(t,ok=true){$('status').style.color=ok?'#8ff7ca':'#ff8ea8';$('status').textContent=t}
    async function api(path,opt={}){const r=await fetch(path,opt);const ct=r.headers.get('content-type')||'';const d=ct.includes('json')?await r.json():{};if(!r.ok)throw new Error(d.error||'Request failed');return d}
    function fill(c){ids.forEach(id=>$(id).value=(c[id]??''));$('aboutLines').value=(c.aboutLines||[]).join('\n');$('links').value=JSON.stringify(c.links||[],null,2);$('projects').value=JSON.stringify(c.projects||[],null,2);$('p').src=c.pfp||'/uploads/default-pfp.svg'}
    function collect(){const o={};ids.forEach(id=>o[id]=$(id).value);o.views=Number(o.views||0);o.cardOpacity=Number(o.cardOpacity||0.75);o.aboutLines=$('aboutLines').value.split('\n').map(x=>x.trim()).filter(Boolean);o.links=JSON.parse($('links').value||'[]');o.projects=JSON.parse($('projects').value||'[]');return o}
    async function upload(file){const f=file.files&&file.files[0];if(!f) throw new Error('Choose a file');const fd=new FormData();fd.append('file',f);const res=await fetch('/api/upload',{method:'POST',body:fd});const d=await res.json();if(!res.ok)throw new Error(d.error||'upload failed');return d.url}
    function renderMsgs(items){$('count').textContent=`${items.length} messages`; $('msgs').innerHTML=items.map(m=>`<article class='msg'><div class='meta'><span><b>${m.name}</b> • ${m.email}</span><span>${new Date(m.created_at).toLocaleString()}</span></div><p>${m.message}</p></article>`).join('')||'<p class="small">No messages yet.</p>'}
    function filter(){const q=$('q').value.toLowerCase().trim();renderMsgs(!q?all:all.filter(m=>`${m.name} ${m.email} ${m.message}`.toLowerCase().includes(q)))}
    async function load(){const c=await api('/api/config');fill(c);all=await api('/api/messages');filter()}

    $('upPfp').onclick=async()=>{try{const u=await upload($('pfpFile'));$('pfp').value=u;$('p').src=u;status('PFP uploaded; save config.')}catch(e){status(e.message,false)}};
    $('upAny').onclick=async()=>{try{const u=await upload($('genericFile'));$('uploadedUrl').value=u;status('Media uploaded. Copy URL into any field/json.')}catch(e){status(e.message,false)}};
    $('f').onsubmit=async(e)=>{e.preventDefault();try{await api('/api/config',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(collect())});status('Saved ✅')}catch(err){status(err.message,false)}};
    $('reload').onclick=()=>load().then(()=>status('Reloaded')).catch(e=>status(e.message,false));
    $('refresh').onclick=()=>load().then(()=>status('Inbox refreshed')).catch(e=>status(e.message,false));
    $('q').oninput=filter;
    load().catch(e=>status(e.message,false));
  </script>
</body>
</html>
